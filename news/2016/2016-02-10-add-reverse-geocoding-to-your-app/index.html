<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <title>Add Reverse Geocoding to Your App - Exceptionless</title>

    <meta name="description" content="Real-time exception reporting for ASP.NET, Web API, WebForms, WPF, Console, and MVC applications. Includes event organization, notifications, and more.">
    <meta name="robots" content="index,follow">
    <meta name="author" content="[object Object]">

    <link rel="canonical" href="NaN">

    <!-- opengraph -->
    <meta property="og:title" content="Add Reverse Geocoding to Your App - Exceptionless">
    <meta property="og:type" content="article">
    <meta property="og:url" content="NaN">
    <meta property="og:description" content="Real-time exception reporting for ASP.NET, Web API, WebForms, WPF, Console, and MVC applications. Includes event organization, notifications, and more.">
    <meta property="og:image" content="undefined/undefined/undefined">
    <!-- end opengraph -->

    <!-- twitter -->
    <meta name="twitter:card" content="summary"><meta name="twitter:site" content="@Exceptionless">
    <meta name="twitter:url" content="NaN">
    <meta name="twitter:title" content="Add Reverse Geocoding to Your App - Exceptionless">
    <meta name="twitter:description" content="Real-time exception reporting for ASP.NET, Web API, WebForms, WPF, Console, and MVC applications. Includes event organization, notifications, and more.">
    <meta name="twitter:image" content="undefined/undefined/undefined">
    <!-- end twitter -->

    <!-- google tag manager -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-433340-8"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-433340-8');
    </script>
    <!-- end google tag manager -->

    <link rel="alternate" href="/website/feed.xml" type="application/atom+xml" title="Exceptionless">
    <link rel="alternate" href="/website/feed.json" type="application/json" title="Exceptionless">
    <link rel="shortcut icon" href="/website/favicon.ico">

    <link rel="stylesheet" href="/website/assets/cyclone-slider-pro/templates/standard/style.css">
    <link rel="stylesheet" href="/website/assets/css/theme.css">
    <link rel="stylesheet" href="/website/assets/css/responsive.css">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,300,400,600" rel="stylesheet">

    <link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link href="/website/assets/css/prism.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

    <link rel="stylesheet" href="/website/assets/css/custom.css">
  </head>
  <body class="home page custom-background top-navbar">
    <header id="banner" class="topnavbar navbar navbar-fixed-top" role="banner">
        <div class="navbar-inner">
            <div class="container">
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <a class="brand" href="/website/">
                    <img id="site-logo" src="/website/assets/img/exceptionless-logo1.png" alt="Exceptionless - .NET Exception Reporting">
                </a>
                <nav id="nav-main" class="nav-main nav-collapse collapse" role="navigation">
                    <ul id="menu-primary-navigation" class="nav pull-right"><li class="menu-tour"><a href="/website/tour/">Tour</a></li>
                        <li class="menu-why"><a href="/website/why/">Why?</a></li>
                        <li class="menu-pricing"><a href="/website/pricing/">Pricing</a></li>
                        <li class="menu-news"><a href="/website/news/">News</a></li>
                        <li class="menu-help"><a href="/website/docs/">Docs</a></li>
                        <li class="menu-log-in"><a href="https://be.exceptionless.io">Log In</a></li>
                        <li class="menu-sign-up"><a href="https://be.exceptionless.io/signup?domain=www.codesmithtools.com&amp;type=organic">Sign Up</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div id="megaDrop" class="container-fluid top-megamenu"><div class="container"><div class="row"></div></div></div>
    </header>

    
      
<div class="page-header margin-top">
  <h1>News</h1>
</div>

<div id="wrap" class="container" role="document">
  <div id="content" class="row-fluid">
    <div id="main" class="span12" role="main">
      
        <article class="post type-post status-publish format-standard hentry category-uncategorized tag-net tag-updates">
          <header>
            <h1 class="entry-title">Add Reverse Geocoding to Your App</h1>
          </header>
          <div class="entry-content">
            <p><img src="/website/assets/img/news/reverse-geocoding-header.jpg" alt="Reverse Geocoding"></p>
<p>We recently introduced reverse geocoding into Exceptionless and are now adding features to make full use of it.</p>
<p>What we'd like to do in this blog article is <strong>walk any interested developers through the process of adding it to their own app.</strong></p>
<p>We'll talk about the resources and services we're using to pull it off, why we chose them, and give you code snippets for implementation. It's all open source, so we've also included links to all the relevant code in hopes it will make your life easier!</p>
<p>Lets check it out.</p>
<h2>What is Reverse Geocoding?</h2>
<!--more-->
<p>It’s the process of taking geo coordinates or an IP Address and resolving it to a physical address (E.G., city, county, state/province, country).</p>
<h3>Why You Need It</h3>
<p><img src="/website/assets/img/news/user-event-geo-location.jpg" alt="Reverse Geocoding - User Location"></p>
<p>Wouldn’t it be nice if you could <strong>provide location services to your users automatically</strong>? Maybe help them fill in a shipping form from a zip code or there current location?</p>
<p>With the launch of Exceptionless 2.0 we added a geo property to all events. This allows us to translate valid latitude and longitude coordinates into a physical location. Our goal was to begin capturing the data then and enable different scenarios and uses later. This also allowed us to <strong>show end users where their customers events are being submitted from.</strong></p>
<h3>What does it cost?</h3>
<p>One of our primary goals with Exceptionless is to be <strong>completely open source and easy to use</strong> (both in setting up self hosting and using the product). We had to take this into account when picking any library or service, because we want a painless setup and no additional costs for self hosters, all while adding additional value!</p>
<p><strong>Please note</strong> that if you love the services we use, you should look into using one of their paid plans&nbsp;or at least promoting them with a positive review, shout out, etc (everyone needs to eat at the end of the day, right?).</p>
<p>After researching&nbsp;many different services, we ended up goin</p>
<p>g with <a href="http://dev.maxmind.com/geoip/geoip2/geolite2/" target="_blank">GeoLite2's free, offline, downloadable databases</a>. These databases are <strong>free and updated once a month</strong>, but if you require a more accurate and up-to-date database they offer a paid subscription. We also use their <a href="https://github.com/maxmind/GeoIP2-dotnet" target="_blank">open source library</a> for interacting with the database in memory.</p>
<h2>Automating the GeoIP Database Download</h2>
<p>We use our very own&nbsp;<a href="https://github.com/FoundatioFx/Foundatio#jobs" target="_blank">Foundatio Jobs</a> to download the most up-to-date database. Foundatio Jobs allows us to run the job in process or out of process on a schedule in Azure.</p>
<p>Alternatively, you could use the <a href="https://github.com/exceptionless/Exceptionless/blob/v3.5.1/Libraries/DownloadGeoIPDatabase.ps1" target="_blank">PowerShell script</a> we created for downloading the database. &nbsp;<code>&lt;a href="https://github.com/exceptionless/Exceptionless/blob/master/src/Exceptionless.Core/Jobs/DownloadGeoIPDatabaseJob.cs" target="_blank"&gt;DownloadGeoIPDatabaseJob&lt;/a&gt;</code> downloads the database over http and extracts the file contents to disk using <a href="https://github.com/FoundatioFx/Foundatio#file-storage" target="_blank">Foundatio Storage</a>.</p>
<p>Please feel free to <strong>take a look out our job</strong> for a complete sample including logging and error handling:</p>
<pre><code class="language-cs hljs language-csharp"><span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> HttpClient();
<span class="hljs-keyword">var</span> file = <span class="hljs-keyword">await</span> client.GetAsync(<span class="hljs-string">"http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"</span>, context.CancellationToken);
<span class="hljs-keyword">if</span> (!file.IsSuccessStatusCode)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Unable to download GeoIP database."</span>);

<span class="hljs-keyword">using</span> (GZipStream decompressionStream = <span class="hljs-keyword">new</span> GZipStream(<span class="hljs-keyword">await</span> file.Content.ReadAsStreamAsync(), CompressionMode.Decompress))
    <span class="hljs-keyword">await</span> _storage.SaveFileAsync(<span class="hljs-string">"GeoLite2-City.mmdb"</span>, decompressionStream, context.CancellationToken);
</code></pre>
<h2>Looking up a Physical Address from an IP Address</h2>
<h4>Resolving the geo coordinates into a location</h4>
<p>After we automate the database download, the next step involves loading the database in memory using the <a href="https://github.com/maxmind/GeoIP2-dotnet" target="_blank">open source library</a> provided by MaxMind and querying by the IP address. The code below will do very basic IP validation and lookup the records using the API.</p>
<pre><code class="language-cs hljs language-csharp"><span class="hljs-keyword">private</span> DatabaseReader _database;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;GeoResult&gt; <span class="hljs-title">ResolveIpAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, CancellationToken cancellationToken = <span class="hljs-keyword">new</span> CancellationToken(</span>))</span> {
    <span class="hljs-keyword">if</span> (String.IsNullOrWhiteSpace(ip) || (!ip.Contains(<span class="hljs-string">"."</span>) &amp;&amp; !ip.Contains(<span class="hljs-string">":"</span>)))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">var</span> database = <span class="hljs-keyword">await</span> GetDatabaseAsync(cancellationToken);
    <span class="hljs-keyword">if</span> (database == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> city = database.City(ip);
        <span class="hljs-keyword">if</span> (city?.Location != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> GeoResult {
                Latitude = city.Location.Latitude,
                Longitude = city.Location.Longitude,
                Country = city.Country.IsoCode,
                Level1 = city.MostSpecificSubdivision.IsoCode,
                Locality = city.City.Name
            };
        }
    } <span class="hljs-keyword">catch</span> (Exception) {
        <span class="hljs-comment">// The result was not found in the database</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;DatabaseReader&gt; <span class="hljs-title">GetDatabaseAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span> {
    <span class="hljs-keyword">if</span> (_database != <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> _database;

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> _storage.ExistsAsync(<span class="hljs-string">"GeoLite2-City.mmdb"</span>)) {
        Logger.Warn().Message(<span class="hljs-string">"No GeoIP database was found."</span>).Write();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> stream = <span class="hljs-keyword">await</span> _storage.GetFileStreamAsync(<span class="hljs-string">"GeoLite2-City.mmdb"</span>, cancellationToken))
            _database = <span class="hljs-keyword">new</span> DatabaseReader(stream);
    } <span class="hljs-keyword">catch</span> (Exception) {
        <span class="hljs-comment">// Unable to open GeoIP database.</span>
    }

    <span class="hljs-keyword">return</span> _database;
}
</code></pre>
<p>Then, just call the <code>ResolveIPAsync</code> method with an IP address to look up the location details.</p>
<pre><code class="language-cs hljs language-csharp"><span class="hljs-keyword">var</span> location = <span class="hljs-keyword">await</span> ResolveIPAsync(<span class="hljs-string">"YOUR_IP_ADDRESS_HERE"</span>);
</code></pre>
<p>Feel free to take a look at&nbsp;<code>&lt;a href="https://github.com/exceptionless/Exceptionless/blob/master/src/Exceptionless.Insulation/Geo/MaxMindGeoIpService.cs" target="_blank"&gt;MaxMindGeoIPService&lt;/a&gt;</code> for a complete sample that&nbsp;includes logging, error handling, caching of the results, and IP validation for higher lookup throughput. We’ve spent the time writing tests and optimizing it to ensure <strong>its rock solid and works great</strong>. So feel free to grab our IGeoIPService interfaces and models and use them in your app.</p>
<p><strong>It’s worth noting</strong> that in our app, we use the IP address provided in the event. This could come from a server request or the actual machine's IP address. We also fall back to the API&nbsp;consumer's client IP address.</p>
<h3>Looking up a Physical Address from Geo Coordinates</h3>
<p>As stated previously, every event submitted to Exceptionless has a geo property that&nbsp;can be set. If it’s set, we will attempt to look up your location by the geo coordinates using a third party service. We used the open source <a href="https://github.com/chadly/Geocoding.net" target="_blank">Geocoding.net library</a>, which abstracts the major different third party reverse geocode services into an easy to use API (options are always good!).</p>
<p>After we decided on the library, we evaluated a few API/lookup&nbsp;services based on cost and accuracy. We ended up going with the <a href="https://developers.google.com/maps/documentation/geocoding/usage-limits" target="_blank">Google Maps GeoCoding API</a>. They offer&nbsp;2500 free requests&nbsp;per day and are one of the most used location services in the world.</p>
<p>Next, let’s write the code that will look up our location from a latitude and longitude. You can find our complete example here.</p>
<p>Remember to get your free api key from Google before running the code below.</p>
<pre><code class="language-cs hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;GeoResult&gt; <span class="hljs-title">ReverseGeocodeAsync</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> latitude, <span class="hljs-built_in">double</span> longitude, CancellationToken cancellationToken = <span class="hljs-keyword">new</span> CancellationToken(</span>))</span> {
    <span class="hljs-keyword">var</span> geocoder = <span class="hljs-keyword">new</span> GoogleGeocoder(<span class="hljs-string">"YOUR_API_KEY"</span>);
    <span class="hljs-keyword">var</span> addresses = <span class="hljs-keyword">await</span> geocoder.ReverseGeocodeAsync(latitude, longitude, cancellationToken);
    <span class="hljs-keyword">var</span> address = addresses.FirstOrDefault();
    <span class="hljs-keyword">if</span> (address == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> GeoResult {
        Country = address[GoogleAddressType.Country]?.ShortName,
        Level1 = address[GoogleAddressType.AdministrativeAreaLevel1]?.ShortName,
        Level2 = address[GoogleAddressType.AdministrativeAreaLevel2]?.ShortName,
        Locality = address[GoogleAddressType.Locality]?.ShortName,
        Latitude = latitude,
        Longitude = longitude
    };
}
</code></pre>
<p>Finally, just call the <code>ReverseGeocodeAsync</code> method with a latitude and longitude to look up the location details.</p>
<pre><code class="language-cs hljs language-csharp"><span class="hljs-keyword">var</span> location = <span class="hljs-keyword">await</span> ResolveGeocodeAsync(<span class="hljs-number">44.5241</span>, <span class="hljs-number">-87.9056</span>);
</code></pre>
<h2>Final Thoughts on Reverse Geocoding</h2>
<p>It took us a bit of work and research initially to get everything working flawlessly for location services. We hope you grab our code off of GitHub to <strong>save yourself all that work</strong>. Also, it’s worth noting that we use <a href="https://github.com/FoundatioFx/Foundatio#caching" target="_blank">Foundatio Caching</a> to cache the results of location lookups. It drastically&nbsp;increased the performance and&nbsp;cut down on our limited number of requests to rate-limited third party services!</p>
<p>We also queue work items to look up the geo location since that&nbsp;can be an expensive operation. So, please take this into consideration anytime you are interacting with a third party service.</p>
<h2>Feedback? Questions?</h2>
<p>Get in touch on <a href="https://github.com/exceptionless" target="_blank">GitHub</a>&nbsp;or leave a comment below to let us know your thoughts or questions. We're always open to suggestions and will do what we can to help you out if you're having issues with implementation!</p>

          </div>
        </article>
            
    </div>
  </div>
</div>

    

    <div id="footer-wrapper">
        <footer id="content-info" class="container" role="contentinfo">
            <div class="row-fluid">
                <div class="span4"><section id="text-2" class="widget-1 widget-first widget widget_text"><div class="widget-inner">			<div class="textwidget"><h3><span class="slash">//</span> Quick Links</h3>
                    <ul class="footer-links clearfix">
                        <li><a href="/website/">Home</a></li>
                        <li><a href="/website/tour/">Tour</a></li>
                        <li><a href="/website/why/">Why?</a></li>
                        <li><a href="/website/pricing/">Pricing</a></li>
                        <li><a href="/website/news/">News</a></li>
                        <li><a href="/website/docs/">Docs</a></li>
                    </ul>
                    <ul class="footer-links clearfix">
                        <li><a href="javascript:Intercom('showNewMessage');">Contact</a></li>
                        <li><a href="https://github.com/exceptionless/Exceptionless" target="_blank" rel="noopener noreferrer">GitHub</a></li>
                        <li><a href="/website/about/">About Us</a></li>
                        <li><a href="/website/terms/">Terms of Use</a></li>
                        <li><a href="/website/privacy/">Privacy Policy</a></li>
                        <li>&nbsp;</li>
                    </ul></div>
                </div></section></div>
                <div class="span3"></div>
                <div class="span4"><section id="text-3" class="widget-1 widget-first widget widget_text"><div class="widget-inner">			<div class="textwidget"><h3><span class="slash">//</span> Stay In Touch</h3>
                    <p>There are real people behind Exceptionless, so if you have a question or suggestion (no matter how small) please get in touch with us:</p>

                    <ul class="social-icons-container">
                        <li>
                            <a href="https://twitter.com/exceptionless" target="_blank" class="social-icon social-icon-twitter" rel="noopener noreferrer">Twitter</a>
                        </li>
                        <li>
                            <a href="https://www.facebook.com/exceptionless" target="_blank" class="social-icon social-icon-facebook" rel="noopener noreferrer">Facebook</a>
                        </li>
                        <li>
                            <a href="https://github.com/exceptionless/Exceptionless" target="_blank" class="social-icon social-icon-github" rel="noopener noreferrer">GitHub</a>
                        </li>
                    </ul></div>
                </div></section></div>
            </div>
        </footer>
        <div class="copyrightContainer">
            <p class="copyright">© 2020 Exceptionless</p>
        </div>
    </div>

    <script src="/website/assets/js/main.js"></script>
    
    <!-- intercom -->
<script>
window.intercomSettings = {
    app_id: "6c0d76e0bec950052459f5cb4b727a949aeabbe1"
};
</script>

<script>
(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/6c0d76e0bec950052459f5cb4b727a949aeabbe1';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
</script>
<!-- end intercom -->

  

</body></html>